<html>
<head>
  <title>Evernote Export</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="YXBJ Windows/605061 (zh-CN, DDL); Windows/10.0.0 (Win64); EDAMVersion=V2;"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="633"/>

<div>
<span><div>通俗流程：代码编辑——》代码编译（二进制固件）（cmake）<span style="font-size: unset; color: unset; font-family: unset;">——》下载到飞控板中——》启动进程（RCS）（RPMFS）——》飞控控制（src）</span></div><div>hello world 程序开发</div><div><br/></div><div>搭建第一个应用</div><div>参考教程： <a href="https://dev.px4.cc/master/zh/apps/hello_sky.html">编写您的第一个应用程序 · PX4 Developer Guide</a></div><div><br/></div><div>1.创建模块目录</div><div>在Px4源码文件中的~/src/examples/目录下创建自己的模块文件夹:px4_hello_czx；</div><div><br/></div><div>2.创建模块主函数，函数格式为：__EXPORT int 函数名_main(int argc, char *argv[]);</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>#include &lt;px4_platform_common/px4_config.h&gt;</div><div>#include &lt;px4_platform_common/tasks.h&gt;</div><div>#include &lt;px4_platform_common/posix.h&gt;</div><div><br/></div><div><br/></div><div>#include &lt;unistd.h&gt;</div><div>#include &lt;stdio.h&gt;</div><div>#include &lt;poll.h&gt;</div><div>#include &lt;string.h&gt;</div><div>#include &lt;math.h&gt;</div><div><br/></div><div><br/></div><div>#include &lt;uORB/uORB.h&gt;</div><div>#include &lt;uORB/topics/vehicle_acceleration.h&gt;</div><div>#include &lt;uORB/topics/vehicle_attitude.h&gt;</div></div><div><br/></div><div>创建模块函数：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><br/></div><div>__EXPORT int px4_hello_czx_main(int argc, char *argv[]);</div></div><div>编辑函数体，编写模块内容：</div><div><a href="https://www.bilibili.com/read/cv5422134">PX4的uORB和他身边的她 - 哔哩哔哩 (bilibili.com)</a></div><div><br/></div><div><img src="px4二次开发-功能模块开发和消息订阅_files/1.jpg" type="image/jpeg" data-filename="1.jpg"/></div><div><img src="px4二次开发-功能模块开发和消息订阅_files/2.jpg" type="image/jpeg" data-filename="2.jpg"/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>int px4_hello_czx_main(int argc, char *argv[])</div><div>{</div><div>    PX4_INFO(&quot;Hello Sky!&quot;); #跟天空打招呼</div><div><br/></div><div>    # 通过消息总线订阅传感器的加速度值    <font color="#AD0000">需要确定uORB消息总线的topic结构</font></div><div>    /* subscribe to vehicle_acceleration topic */    </div><div>    # 订阅函数为 orb_subscribe(),其中加速度的topic已经在固件中定义完成     </div><div>    int sensor_sub_fd = orb_subscribe(ORB_ID(vehicle_acceleration));</div><div>    /* limit the update rate to 5 Hz */</div><div>    # orb_set_interval 指定数据拉取频率, topic名和时间间隔</div><div>    orb_set_interval(sensor_sub_fd, 200);</div><div><br/></div><div>    # 广播 姿态传感器数据？</div><div>    /* advertise attitude topic */</div><div>    # 定义姿态结构体</div><div>    struct vehicle_attitude_s att;</div><div><span style="font-size: 9pt; color: rgb(51, 51, 51); font-family: Monaco;">        # 姿态结构体内存初始化</span></div><div>    memset(&amp;att, 0, sizeof(att));</div><div>    # 公告姿态值</div><div>    orb_advert_t att_pub = orb_advertise(ORB_ID(vehicle_attitude), &amp;att);</div><div><br/></div><div><br/></div><div>    /* one could wait for multiple topics with this technique, just using one here */</div><div>    px4_pollfd_struct_t fds[] = {</div><div>        # 监视加速度测量结果的topic</div><div>        { .fd = sensor_sub_fd,   .events = POLLIN },</div><div>        /* there could be more file descriptors here, in the form like:</div><div>         * { .fd = other_sub_fd,   .events = POLLIN },</div><div>         */</div><div>    };</div><div><br/></div><div><br/></div><div>    int error_counter = 0;</div><div><br/></div><div><br/></div><div>    for (int i = 0; i &lt; 5; i++) {</div><div>        /* wait for sensor update of 1 file descriptor for 1000 ms (1 second) */</div><div>        int poll_ret = <font style="color: rgb(173, 0, 0);">px4_poll</font>(fds, 1, 1000);</div><div><br/></div><div><br/></div><div>        /* handle the poll result */</div><div>        if (poll_ret == 0) {</div><div>            /* this means none of our providers is giving us data */</div><div>            PX4_ERR(&quot;Got no data within a second&quot;);</div><div><br/></div><div><br/></div><div>        } else if (poll_ret &lt; 0) {</div><div>            /* this is seriously bad - should be an emergency */</div><div>            if (error_counter &lt; 10 || error_counter % 50 == 0) {</div><div>                /* use a counter to prevent flooding (and slowing us down) */</div><div>                PX4_ERR(&quot;ERROR return value from poll(): %d&quot;, poll_ret);</div><div>            }</div><div><br/></div><div><br/></div><div>            error_counter++;</div><div><br/></div><div><br/></div><div>        } else {</div><div>            # 监视有真确输出</div><div>            if (fds[0].revents &amp; POLLIN) {</div><div>                /* obtained data for the first file descriptor */</div><div>                # 定义加速度输出值</div><div>                struct vehicle_acceleration_s accel;</div><div>                /* copy sensors raw data into local buffer */</div><div>                orb_copy(ORB_ID(vehicle_acceleration), sensor_sub_fd, &amp;accel);</div><div>                PX4_INFO(&quot;Accelerometer:\t%8.4f\t%8.4f\t%8.4f&quot;,</div><div>                     (double)accel.xyz[0],</div><div>                     (double)accel.xyz[1],</div><div>                     (double)accel.xyz[2]);</div><div><br/></div><div><br/></div><div>                /* set att and publish this information for other apps</div><div>                 the following does not have any meaning, it's just an example</div><div>                */</div><div>                # 姿态结算部分未做处理</div><div>                att.q[0] = accel.xyz[0];</div><div>                att.q[1] = accel.xyz[1];</div><div>                att.q[2] = accel.xyz[2];</div><div><br/></div><div>                # 发布姿态信息</div><div>                orb_publish(ORB_ID(vehicle_attitude), att_pub, &amp;att);</div><div>            }</div><div><br/></div><div><br/></div><div>            /* there could be more file descriptors here, in the form like:</div><div>             * if (fds[1..n].revents &amp; POLLIN) {}</div><div>             */</div><div>        }</div><div>    }</div><div><br/></div><div><br/></div><div>    PX4_INFO(&quot;exiting&quot;);</div><div><br/></div><div><br/></div><div>    return 0;</div><div>}</div><div><br/></div></div><div>3.编写编译脚本</div><div>通过px4_add_module()函数生成静态库。其中MAIN列出模块的名称，该名称会作为Nuttx的注册命令，以便可以从Px4命令行或者SITL（px4仿真环境）控制台调用该模块。</div><div>SRCS指定模块程序所在</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>px4_add_module(</div><div>    MODULE examples__px4_hello_czx</div><div>    MAIN px4_hello_czx</div><div>    SRCS</div><div>        px4_hello_czx.c</div><div>    DEPENDS</div><div>    )</div></div><div>新版的px4的编译脚本不再通过default.cmake实现，而是通过kconfig的一种新的方式去实现。需要进行三处添加：</div><div>a. 模块文件夹下的kconfig文件和CMakelist.txt</div><div><img src="px4二次开发-功能模块开发和消息订阅_files/4.JPG" type="image/jpeg" data-filename="4.JPG"/></div><div>最终功能模块下的文件包含三部分：模块函数、编译文件和kconfig文件。</div><div><img src="px4二次开发-功能模块开发和消息订阅_files/5.JPG" type="image/jpeg" data-filename="5.JPG"/></div><div>b. 在~/boards/px4/对应版本文件下（仿真为sitl）/default.px4board文件中添加模块文件的路径及文件名，用大写的形式连接起来，如下图所示。</div><div>CONFIG_目录_模块目录</div><div><img src="px4二次开发-功能模块开发和消息订阅_files/6.JPG" type="image/jpeg" data-filename="6.JPG"/></div><div><br/></div><div>4.编译px4固件在仿真下运行gazebo ：make px4_sitl_default gazebo</div><div><br/></div><div><br/></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>make px4_sitl_default gazebo</div><div>pxh&gt;px4_hello_czx</div><div><br/></div></div><div>运行成功，陈宫读取加速度信息和日志打印。</div><div><img src="px4二次开发-功能模块开发和消息订阅_files/3.JPG" type="image/jpeg" data-filename="3.JPG"/></div><div><br/></div><div><span style="color: rgb(173, 0, 0);">但是 自带的dyn hello 一直未成功？</span></div><div><br/></div><div><span style="font-weight: bold; font-size: 12pt;">自定义uORB消息，并实现发布消息和订阅消息</span></div><div><br/></div><div>自定义消息在px4官网中有两种方式，一种是常用的在px4原有的代码结构中去添加，另一种是自定义文档结构和目录的out-of-tree的方式，此处先了解前一种的方式，学习uORB的消息机制。</div><div><br/></div><div>1.在msg的文件目录下创建自己的消息文件.msg， 本文创建了czx_uorb_topic.msg。</div><div>创建消息内容，即msg文件的具体内容，其中首行px4要求必须包含  “uint64 timestamp”原因是： <span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(173, 0, 0); font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, Oxygen, Ubuntu, Cantarell, &quot;Fira Sans&quot;, &quot;Droid Sans&quot;, &quot;Helvetica Neue&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">对于每个生成的 C/C + 结构体，都将添加一个</span><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; background-color: rgb(255, 255, 255); color: rgb(173, 0, 0); font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, Oxygen, Ubuntu, Cantarell, &quot;Fira Sans&quot;, &quot;Droid Sans&quot;, &quot;Helvetica Neue&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;"> </span><span style="font-size: 0.85em; background-color: rgba(27, 31, 35, 0.05); border-radius: 3px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(173, 0, 0); font-family: source-code-pro, Menlo, Monaco, Consolas, &quot;Courier New&quot;, monospace; font-variant-caps: normal; font-variant-ligatures: normal;">uint64_t timestamp</span><span style="font-size: 16px; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(173, 0, 0); font-family: -apple-system, BlinkMacSystemFont, &quot;Segoe UI&quot;, Roboto, Oxygen, Ubuntu, Cantarell, &quot;Fira Sans&quot;, &quot;Droid Sans&quot;, &quot;Helvetica Neue&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">字段。 此用于记录日志，因此请确保在发布时填充数据。</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div><font style="color: rgb(173, 0, 0);">uint64 timestamp # time since system start (microseconds)</font></div><div><font style="color: rgb(173, 0, 0);"><br/></font></div><div><font style="color: rgb(173, 0, 0);"><br/></font></div><div><font style="color: rgb(173, 0, 0);">bool run_new_topic #  the new topic create success or fail</font></div><div><font style="color: rgb(173, 0, 0);"><br/></font></div><div><font style="color: rgb(173, 0, 0);"><br/></font></div><div><font style="color: rgb(173, 0, 0);">float32 sp_x</font></div></div><div>2.在msg文件的编译文件CMakeList.txt 的set（msg_files）中添加新建的msg文件。</div><div><br/></div><div><span style="font-size: 10pt;">px4</span><span style="font-size: 10pt; color: rgb(18, 18, 18); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: bold;">内部机制，可根据配置</span><span style="font-size: 10pt; color: rgb(18, 18, 18); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-weight: bold;">自动生成代码，从而使整个软件的系统架构更加标准和易用，</span><span style="color: rgb(18, 18, 18); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;">减少用户的重复性代码编辑，比如Mavlink、uavcan、param的消息创建以及部分gazebo模型文件的生成。</span><span style="color: rgb(18, 18, 18); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif;">uORB的代码生成脚本位于 msg/tools，使用python进行代码生成。可根据我们新建的topic文件和编译文件中的添加，在编译时自动生成消息的.h和.c文件。</span> <span style="font-size: medium; letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; color: rgb(18, 18, 18); font-family: -apple-system, BlinkMacSystemFont, &quot;Helvetica Neue&quot;, &quot;PingFang SC&quot;, &quot;Microsoft YaHei&quot;, &quot;Source Han Sans SC&quot;, &quot;Noto Sans CJK SC&quot;, &quot;WenQuanYi Micro Hei&quot;, sans-serif; font-variant-caps: normal; font-variant-ligatures: normal;">生成的文件在 build/选择的编译模式/msg/tmp目录下可以找到，包括一个头文件目录和一个cpp文件目录，阅读创建的文件内容可以大概了解主要创建了什么内容。</span></div><div><br/></div><div>生成的头文件为：czx_uorb_topic.h， 内容如下：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>/****************************************************************************</div><div>*</div><div>*   Copyright (C) 2013-2021 PX4 Development Team. All rights reserved.</div><div>*</div><div>* Redistribution and use in source and binary forms, with or without</div><div>* modification, are permitted provided that the following conditions</div><div>* are met:</div><div>*</div><div>* 1. Redistributions of source code must retain the above copyright</div><div>*    notice, this list of conditions and the following disclaimer.</div><div>* 2. Redistributions in binary form must reproduce the above copyright</div><div>*    notice, this list of conditions and the following disclaimer in</div><div>*    the documentation and/or other materials provided with the</div><div>*    distribution.</div><div>* 3. Neither the name PX4 nor the names of its contributors may be</div><div>*    used to endorse or promote products derived from this software</div><div>*    without specific prior written permission.</div><div>*</div><div>* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</div><div>* &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</div><div>* LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</div><div>* FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</div><div>* COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</div><div>* INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</div><div>* BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</div><div>* OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</div><div>* AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</div><div>* LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</div><div>* ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</div><div>* POSSIBILITY OF SUCH DAMAGE.</div><div>*</div><div>****************************************************************************/</div><div><br/></div><div><br/></div><div>/* Auto-generated by genmsg_cpp from file /home/czx/Px4/PX4-Autopilot/msg/czx_uorb_topic.msg */</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>#pragma once</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>#include &lt;uORB/uORB.h&gt;</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>#ifndef __cplusplus</div><div><br/></div><div><br/></div><div>#endif</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>#ifdef __cplusplus</div><div>struct __EXPORT czx_uorb_topic_s {</div><div>#else</div><div>struct czx_uorb_topic_s {</div><div>#endif</div><div>    uint64_t timestamp;</div><div>    float sp_x;</div><div>    bool run_new_topic;</div><div>    uint8_t _padding0[3]; // required for logger</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>#ifdef __cplusplus</div><div><br/></div><div><br/></div><div>#endif</div><div>};</div><div><br/></div><div><br/></div><div>/* register this as object request broker structure */</div><div>ORB_DECLARE(czx_uorb_topic);</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>#ifdef __cplusplus</div><div>void print_message(const orb_metadata *meta, const czx_uorb_topic_s&amp; message);</div><div>#endif</div><div><br/></div><div><br/></div></div><div>生成的czx_uorb_topic.cpp文件，内容如下：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>/****************************************************************************</div><div>*</div><div>*   Copyright (C) 2013-2021 PX4 Development Team. All rights reserved.</div><div>*</div><div>* Redistribution and use in source and binary forms, with or without</div><div>* modification, are permitted provided that the following conditions</div><div>* are met:</div><div>*</div><div>* 1. Redistributions of source code must retain the above copyright</div><div>*    notice, this list of conditions and the following disclaimer.</div><div>* 2. Redistributions in binary form must reproduce the above copyright</div><div>*    notice, this list of conditions and the following disclaimer in</div><div>*    the documentation and/or other materials provided with the</div><div>*    distribution.</div><div>* 3. Neither the name PX4 nor the names of its contributors may be</div><div>*    used to endorse or promote products derived from this software</div><div>*    without specific prior written permission.</div><div>*</div><div>* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</div><div>* &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</div><div>* LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</div><div>* FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</div><div>* COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</div><div>* INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</div><div>* BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</div><div>* OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</div><div>* AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</div><div>* LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</div><div>* ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</div><div>* POSSIBILITY OF SUCH DAMAGE.</div><div>*</div><div>****************************************************************************/</div><div><br/></div><div><br/></div><div>/* Auto-generated by genmsg_cpp from file /home/czx/Px4/PX4-Autopilot/msg/czx_uorb_topic.msg */</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>#include &lt;inttypes.h&gt;</div><div>#include &lt;px4_platform_common/log.h&gt;</div><div>#include &lt;px4_platform_common/defines.h&gt;</div><div>#include &lt;uORB/topics/czx_uorb_topic.h&gt;</div><div>#include &lt;uORB/topics/uORBTopics.hpp&gt;</div><div>#include &lt;drivers/drv_hrt.h&gt;</div><div>#include &lt;lib/drivers/device/Device.hpp&gt;</div><div>#include &lt;lib/matrix/matrix/math.hpp&gt;</div><div>#include &lt;lib/mathlib/mathlib.h&gt;</div><div><br/></div><div><br/></div><div>constexpr char __orb_czx_uorb_topic_fields[] = &quot;\x89 timestamp;\x8a sp_x;\x8c run_new_topic;\x86[3] _padding0;&quot;;</div><div><br/></div><div><br/></div><div>ORB_DEFINE(czx_uorb_topic, struct czx_uorb_topic_s, 13, __orb_czx_uorb_topic_fields, static_cast&lt;uint8_t&gt;(ORB_ID::czx_uorb_topic));</div><div><br/></div><div><br/></div><div><br/></div><div><br/></div><div>void print_message(const orb_metadata *meta, const czx_uorb_topic_s&amp; message)</div><div>{</div><div>    if (sizeof(message) != meta-&gt;o_size) {</div><div>        printf(&quot;unexpected message size for %s: %zu != %i\n&quot;, meta-&gt;o_name, sizeof(message), meta-&gt;o_size);</div><div>        return;</div><div>    }</div><div>    orb_print_message_internal(meta, &amp;message, true);</div><div>}</div></div><div><br/></div><div>在之前新建的功能模块中公告、发布和订阅该消息。在编译完成后，px4会自动为新的topic生成消息ID ORBID。</div><div><br/></div><div>修改之前的功能模块，导入新建的uorb消息，订阅加速度传感器信息，并完成新消息的公告。并通过接收加速度的消息，来为新的消息节点赋值。然后对消息进行发布。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>/****************************************************************************</div><div>*</div><div>*   Copyright (c) 2012-2019 PX4 Development Team. All rights reserved.</div><div>*</div><div>* Redistribution and use in source and binary forms, with or without</div><div>* modification, are permitted provided that the following conditions</div><div>* are met:</div><div>*</div><div>* 1. Redistributions of source code must retain the above copyright</div><div>*    notice, this list of conditions and the following disclaimer.</div><div>* 2. Redistributions in binary form must reproduce the above copyright</div><div>*    notice, this list of conditions and the following disclaimer in</div><div>*    the documentation and/or other materials provided with the</div><div>*    distribution.</div><div>* 3. Neither the name PX4 nor the names of its contributors may be</div><div>*    used to endorse or promote products derived from this software</div><div>*    without specific prior written permission.</div><div>*</div><div>* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</div><div>* &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</div><div>* LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</div><div>* FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</div><div>* COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</div><div>* INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</div><div>* BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</div><div>* OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</div><div>* AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</div><div>* LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</div><div>* ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</div><div>* POSSIBILITY OF SUCH DAMAGE.</div><div>*</div><div>****************************************************************************/</div><div><br/></div><div><br/></div><div>/**</div><div>* @file px4_hello_czx.c</div><div>* Minimal application example for PX4 autopilot</div><div>*</div><div>* @author Example czx &lt;mail@example.com&gt;</div><div>*/</div><div><br/></div><div><br/></div><div>#include &lt;px4_platform_common/px4_config.h&gt;</div><div>#include &lt;px4_platform_common/tasks.h&gt;</div><div>#include &lt;px4_platform_common/posix.h&gt;</div><div>#include &lt;unistd.h&gt;</div><div>#include &lt;stdio.h&gt;</div><div>#include &lt;poll.h&gt;</div><div>#include &lt;string.h&gt;</div><div>#include &lt;math.h&gt;</div><div><br/></div><div><br/></div><div>#include &lt;uORB/uORB.h&gt;</div><div>#include &lt;uORB/topics/vehicle_acceleration.h&gt;</div><div>#include &lt;uORB/topics/vehicle_attitude.h&gt;</div><div><br/></div><div><br/></div><div><font style="color: rgb(173, 0, 0);">#include &lt;uORB/topics/czx_uorb_topic.h&gt;</font></div><div><br/></div><div><br/></div><div>__EXPORT int px4_hello_czx_main(int argc, char *argv[]);</div><div><br/></div><div><br/></div><div>int px4_hello_czx_main(int argc, char *argv[])</div><div>{</div><div>    PX4_INFO(&quot;Hello Sky!&quot;);</div><div><br/></div><div><br/></div><div>    /* subscribe to vehicle_acceleration topic */</div><div>    int sensor_sub_fd = orb_subscribe(ORB_ID(vehicle_acceleration));</div><div>    /* limit the update rate to 10 Hz */</div><div>    orb_set_interval(sensor_sub_fd, 100);</div><div><br/></div><div><br/></div><div>    /* advertise attitude topic */</div><div><font color="#7B003D">    struct czx_uorb_topic_s czx_topic;</font></div><div><font color="#7B003D">    memset(&amp;czx_topic, 0, sizeof(czx_topic));</font></div><div><font color="#7B003D">    orb_advert_t czx_topic_pub = orb_advertise(ORB_ID(czx_uorb_topic), &amp;czx_topic);</font></div><div><br/></div><div><br/></div><div>    /* one could wait for multiple topics with this technique, just using one here */</div><div>    px4_pollfd_struct_t fds[] = {</div><div>        { .fd = sensor_sub_fd,   .events = POLLIN },</div><div>        /* there could be more file descriptors here, in the form like:</div><div>         * { .fd = other_sub_fd,   .events = POLLIN },</div><div>         */</div><div>    };</div><div><br/></div><div><br/></div><div>    int error_counter = 0;</div><div><br/></div><div><br/></div><div>    for (int i = 0; i &lt; 50; i++) {</div><div>        /* wait for sensor update of 1 file descriptor for 1000 ms (1 second) */</div><div>        int poll_ret = px4_poll(fds, 1, 1000);</div><div><br/></div><div><br/></div><div>        /* handle the poll result */</div><div>        if (poll_ret == 0) {</div><div>            /* this means none of our providers is giving us data */</div><div>            PX4_ERR(&quot;Got no data within a second&quot;);</div><div><br/></div><div><br/></div><div>        } else if (poll_ret &lt; 0) {</div><div>            /* this is seriously bad - should be an emergency */</div><div>            if (error_counter &lt; 10 || error_counter % 50 == 0) {</div><div>                /* use a counter to prevent flooding (and slowing us down) */</div><div>                PX4_ERR(&quot;ERROR return value from poll(): %d&quot;, poll_ret);</div><div>            }</div><div><br/></div><div><br/></div><div>            error_counter++;</div><div><br/></div><div><br/></div><div>        } else {</div><div><br/></div><div><br/></div><div>            if (fds[0].revents &amp; POLLIN) {</div><div>                /* obtained data for the first file descriptor */</div><div>                struct vehicle_acceleration_s accel;</div><div>                /* copy sensors raw data into local buffer */</div><div>                orb_copy(ORB_ID(vehicle_acceleration), sensor_sub_fd, &amp;accel);</div><div>                PX4_INFO(&quot;Accelerometer:\t%8.4f\t%8.4f\t%8.4f&quot;,</div><div>                     (double)accel.xyz[0],</div><div>                     (double)accel.xyz[1],</div><div>                     (double)accel.xyz[2]);</div><div><br/></div><div><br/></div><div>                /* set att and publish this information for other apps</div><div>                 the following does not have any meaning, it's just an example</div><div>                */</div><div>            /*</div><div>                att.q[0] = accel.xyz[0];</div><div>                att.q[1] = accel.xyz[1];</div><div>                att.q[2] = accel.xyz[2]; */</div><div><font color="#AD0000">                czx_topic.run_new_topic = true;</font></div><div><font color="#AD0000">                czx_topic.sp_x = (float)accel.xyz[0];</font></div><div><font color="#AD0000">                orb_publish(ORB_ID(czx_uorb_topic), czx_topic_pub, &amp;czx_topic);</font></div><div>                PX4_INFO(&quot;czx_topic has been publishe!&quot;);</div><div>            }</div><div><br/></div><div><br/></div><div>            /* there could be more file descriptors here, in the form like:</div><div>             * if (fds[1..n].revents &amp; POLLIN) {}</div><div>             */</div><div>        }</div><div>    }</div><div>    PX4_INFO(&quot;exiting&quot;);</div><div><br/></div><div><br/></div><div>    return 0;</div><div>}</div><div><br/></div><div><br/></div></div><div><br/></div><div>新建接收该消息的功能模块。该模块在原模块的基础上修改，完成对新的topic的订阅、监测和接收。具体代码如下所示，编译同前文。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>/****************************************************************************</div><div>*</div><div>*   Copyright (c) 2012-2019 PX4 Development Team. All rights reserved.</div><div>*</div><div>* Redistribution and use in source and binary forms, with or without</div><div>* modification, are permitted provided that the following conditions</div><div>* are met:</div><div>*</div><div>* 1. Redistributions of source code must retain the above copyright</div><div>*    notice, this list of conditions and the following disclaimer.</div><div>* 2. Redistributions in binary form must reproduce the above copyright</div><div>*    notice, this list of conditions and the following disclaimer in</div><div>*    the documentation and/or other materials provided with the</div><div>*    distribution.</div><div>* 3. Neither the name PX4 nor the names of its contributors may be</div><div>*    used to endorse or promote products derived from this software</div><div>*    without specific prior written permission.</div><div>*</div><div>* THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</div><div>* &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</div><div>* LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS</div><div>* FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE</div><div>* COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,</div><div>* INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,</div><div>* BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS</div><div>* OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED</div><div>* AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</div><div>* LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN</div><div>* ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE</div><div>* POSSIBILITY OF SUCH DAMAGE.</div><div>*</div><div>****************************************************************************/</div><div><br/></div><div><br/></div><div>/**</div><div>* @file px4_test_czx.c</div><div>* Minimal application example for PX4 autopilot</div><div>*</div><div>* @author Example czx &lt;mail@example.com&gt;</div><div>*/</div><div><br/></div><div><br/></div><div>#include &lt;px4_platform_common/px4_config.h&gt;</div><div>#include &lt;px4_platform_common/tasks.h&gt;</div><div>#include &lt;px4_platform_common/posix.h&gt;</div><div>#include &lt;unistd.h&gt;</div><div>#include &lt;stdio.h&gt;</div><div>#include &lt;poll.h&gt;</div><div>#include &lt;string.h&gt;</div><div>#include &lt;math.h&gt;</div><div><br/></div><div><br/></div><div>#include &lt;uORB/uORB.h&gt;</div><div>#include &lt;uORB/topics/vehicle_acceleration.h&gt;</div><div>#include &lt;uORB/topics/vehicle_attitude.h&gt;</div><div><br/></div><div><br/></div><div>#include &lt;uORB/topics/czx_uorb_topic.h&gt;</div><div><br/></div><div><br/></div><div>__EXPORT int px4_test_czx_main(int argc, char *argv[]);</div><div><br/></div><div><br/></div><div>int px4_test_czx_main(int argc, char *argv[])</div><div>{</div><div>    PX4_INFO(&quot;Hello Sky!&quot;);</div><div><br/></div><div><br/></div><div>    /* subscribe to vehicle_acceleration topic */</div><div>    int czx_sub_fd = orb_subscribe(ORB_ID(czx_uorb_topic));</div><div>    /* limit the update rate to 2 Hz */</div><div>    orb_set_interval(czx_sub_fd, 500);</div><div><br/></div><div><br/></div><div>    /* one could wait for multiple topics with this technique, just using one here */</div><div>    px4_pollfd_struct_t fds[] = {</div><div>        { .fd = czx_sub_fd,   .events = POLLIN },</div><div>        /* there could be more file descriptors here, in the form like:</div><div>         * { .fd = other_sub_fd,   .events = POLLIN },</div><div>         */</div><div>    };</div><div><br/></div><div><br/></div><div>    int error_counter = 0;</div><div><br/></div><div><br/></div><div>    for (int i = 0; i &lt; 50; i++) {</div><div>        /* wait for sensor update of 1 file descriptor for 1000 ms (1 second) */</div><div>        int poll_ret = px4_poll(fds, 1, 1000);</div><div><br/></div><div><br/></div><div>        /* handle the poll result */</div><div>        if (poll_ret == 0) {</div><div>            /* this means none of our providers is giving us data */</div><div>            PX4_ERR(&quot;Got no data within a second&quot;);</div><div><br/></div><div><br/></div><div>        } else if (poll_ret &lt; 0) {</div><div>            /* this is seriously bad - should be an emergency */</div><div>            if (error_counter &lt; 10 || error_counter % 50 == 0) {</div><div>                /* use a counter to prevent flooding (and slowing us down) */</div><div>                PX4_ERR(&quot;ERROR return value from poll(): %d&quot;, poll_ret);</div><div>            }</div><div><br/></div><div><br/></div><div>            error_counter++;</div><div><br/></div><div><br/></div><div>        } else {</div><div><br/></div><div><br/></div><div>            if (fds[0].revents &amp; POLLIN) {</div><div>                /* obtained data for the first file descriptor */</div><div>                struct czx_uorb_topic_s czx;</div><div>                /* copy sensors raw data into local buffer */</div><div>                orb_copy(ORB_ID(czx_uorb_topic), czx_sub_fd, &amp;czx);</div><div>                PX4_INFO(&quot;news receive!&quot;);</div><div>                PX4_INFO(&quot;czx news :\t%d\t%8.4f&quot;,</div><div>                     czx.run_new_topic,</div><div>                     (double)czx.sp_x);</div><div><br/></div><div><br/></div><div>                /* set att and publish this information for other apps</div><div>                 the following does not have any meaning, it's just an example</div><div>                */</div><div>            /*</div><div>                att.q[0] = accel.xyz[0];</div><div>                att.q[1] = accel.xyz[1];</div><div>                att.q[2] = accel.xyz[2]; */</div><div>            }</div><div><br/></div><div><br/></div><div>            /* there could be more file descriptors here, in the form like:</div><div>             * if (fds[1..n].revents &amp; POLLIN) {}</div><div>             */</div><div>        }</div><div>    }</div><div>    PX4_INFO(&quot;exiting&quot;);</div><div><br/></div><div><br/></div><div>    return 0;</div><div>}</div><div><br/></div><div><br/></div></div><div>编译PX4在仿真环境下运行</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;"><div>make px4_sitl gazebo_plane</div></div><div>编译完成，运行help，检查新建的模块是否出现在命令列表中：</div><div><img src="px4二次开发-功能模块开发和消息订阅_files/捕获.JPG" type="image/jpeg" data-filename="捕获.JPG"/></div><div>存在，然后先运行新topic的公告和发布命令：px4_hello_czx</div><div>新的消息更新2次</div><div>再运行新消息的接收命令：px4_test_czx</div><div><img src="px4二次开发-功能模块开发和消息订阅_files/2.JPG" type="image/jpeg" data-filename="2.JPG"/></div><div>完成接收，但只接收到一次。分析原因：uORB的消息机制是异步发送，发送者只管发送，不管接收，接收者只管接收，不管何时发送，只接收最新消息。而上述操作是先多次发送，然后再接收，就导致之前的消息被后来者覆盖更新，而在接收程序启动后，发送消息模块停止发送。故只接收到最后一帧消息。</div><div><br/></div><div><br/></div><div><br/></div></span>
</div></body></html> 